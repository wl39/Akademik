package uk.ac.standrews.cs.host.cs3099user20.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import io.swagger.v3.oas.annotations.media.Schema;

import java.io.File;
import java.nio.file.Files;
import java.nio.file.Path;

public class FileData extends SimpleFile {

    @Schema(example = "I2luY2x1ZGUgIkNhbGN1bGF0b3IuaCIKI2luY2x1ZGUgPHN0ZGxpYi5oPgojaW5jbHVkZSA8c3RkaW8uaD4KI2luY2x1ZGUgPHN0cmluZy5oPgoKLy9Db25zdGFudHMgdG8gYmUgdXNlZCB0byByZXByZXNlbnQgQVNDSUkgdmFsdWVzIG9mIHZhcmlvdXMgc2lnbnMKY29uc3QgaW50IE5FV0xJTkUgPSAxMDsKY29uc3QgaW50IFNQQUNFID0gMzI7CmNvbnN0IGludCBNVUxUSVBMSUNBVElPTiA9IDQyOwpjb25zdCBpbnQgQURESVRJT04gPSA0MzsKY29uc3QgaW50IFNVQlRSQUNUSU9OID0gNDU7CmNvbnN0IGludCBESVZJU0lPTiA9IDQ3Owpjb25zdCBpbnQgWkVSTyA9IDQ4OwoKLy9DcmVhdGVzIG5ldyBjYWxjdWxhdG9yIG9iamVjdApDYWxjdWxhdG9yICpuZXdfQ2FsY3VsYXRvcigpIHsKICAgIC8vQWxsb2NhdGVzIG1lbW9yeSBhcHByb3ByaXRlbHkKICAgIENhbGN1bGF0b3IqIHRoaXMgPSBtYWxsb2Moc2l6ZW9mKENhbGN1bGF0b3IpKTsKICAgIHRoaXMtPnN0YWNrID0gbmV3X1N0YWNrKCk7CiAgICByZXR1cm4gdGhpczsKfTsKCgovKgogKiBQcm9jZXNzZXMgUlBOIGZvcm1hdHRlZCBtYXRoZW1hdGljcyBlcXVhdGlvbnMuIFRha2VzIGlucHV0IGFuZCBvdXRwdXRzIHJlc3VsdAogKi8Kdm9pZCBDYWxjdWxhdGUoQ2FsY3VsYXRvciogdGhpcykgewogICAgLy9HZXRzIGxpbmUgb2Ygc3RhbmRhcmQgaW5wdXQgdXBvbiBpbml0aWFsaXNhdGlvbgogICAgaW50IGMgPSBmZ2V0YyhzdGRpbik7CiAgICAvL1JlcHJlc2VudHMgYSBudW1iZXIgLSBnaXZlbiBzaXplIDEwMCB0byBhbGxvdyBmb3IgbGFyZ2UgY29tcHV0YXRpb24KICAgIGNoYXIgbnVtWzEwMF07CiAgICAvL1JlcHJlc2VudHMgYWRkaXRpb25hbCBudW1lcmljYWwgZGlnaXRzIHRvIGJlIGFkZGVkIHRvIG51bWJlciBpZiByZXF1aXJlZAogICAgY2hhciBudW0xWzEwMF07CiAgICAvL1JlcHJlc2VudHMgZmxvYXQgdmFsdWUgdG8gYmUgYWRkZWQgdG8gc3RhY2sKICAgIGZsb2F0IGY7CiAgICAvL1JlcHJlc2VudHMgdmFsaWQgY2hhciB2YWx1ZXMgdG8gYmUgcGFydCBvZiBmbG9hdAogICAgY2hhciB2YWx1ZXNbMTFdID0gezQ2LCA0OCwgNDksIDUwLCA1MSwgNTIsIDUzLCA1NCwgNTUsIDU2LCA1N307CgogICAgaW50IGlzRmxvYXQgPSAwOwoKICAgIC8vUmVwcmVzZW50cyBmaW5hbCByZXN1bHQsIHJlc3VsdCBvbmNlIHBvcHBlZCB3aWxsIGJlIHBsYWNlZCBoZXJlCiAgICBmbG9hdCByZXN1bHQ7CiAgICBmbG9hdCAqcmVzID0gJnJlc3VsdDsKCiAgICAvL0NvbnRpbnVlcyB1bnRpbCBlcXVhdGlvbiBlbmRzLCBlaXRoZXIgdGhyb3VnaCBFT0Ygb3IgYSBuZXcgbGluZQogICAgd2hpbGUoIShjID09IE5FV0xJTkUgfHwgYyA9PSBFT0YpKSB7CiAgICAgICAgaWYgKGMgPT0gU1BBQ0UpIHsKICAgICAgICAgICAgLy9tb3ZlcyB0byBuZXh0IGNoYXJhY3RlciBhZnRlciBkZXRlY3Rpbmcgc3BhY2UgZm9yIGVmZmljaWVuY3kKICAgICAgICAgICAgYyA9IGZnZXRjKHN0ZGluKTsKICAgICAgICAgICAgc3dpdGNoIChjKSB7CiAgICAgICAgICAgICAgICAvL0FzIG11bHRpcGxpY2F0aW9uLCBhZGRpdGlvbiwgYW5kIGRpdmlzaW9uIGhhdmUgdGhlIHNhbWUgcmVxdWlyZW1lbnRzLCBjYWxscyBvbiBPcGVyYXRlIGZ1bmN0aW9uIGlmIGFueSBmb3VuZAogICAgICAgICAgICAgICAgY2FzZSAoTVVMVElQTElDQVRJT04pIDoKICAgICAgICAgICAgICAgIGNhc2UgKEFERElUSU9OKSA6CiAgICAgICAgICAgICAgICBjYXNlIChESVZJU0lPTikgOgogICAgICAgICAgICAgICAgICAgIE9wZXJhdGUoYyx0aGlzLT4gc3RhY2spOwogICAgICAgICAgICAgICAgICAgIC8vQWZ0ZXIgcGVyZm9ybWluZyBvcGVyYXRpb24sIG1vdmVzIHRvIG5leHQgY2hhcmFjdGVyIGZvbGxvd2luZyBFUSAtIGFsd2F5cyBlaXRoZXIgRU9GIG9yIGEgc3BhY2UKICAgICAgICAgICAgICAgICAgICBjID0gZmdldGMoc3RkaW4pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAoU1VCVFJBQ1RJT04pICA6CiAgICAgICAgICAgICAgICAgICAgLy9Nb3ZlcyBmb3J3YXJkIHRvIGV2YWx1YXRlIHR5cGUgb2YgbWludXMgc2lnbgogICAgICAgICAgICAgICAgICAgIGMgPSBmZ2V0YyhzdGRpbik7CiAgICAgICAgICAgICAgICAgICAgLy9DaGVja3MgaWYgb3BlcmF0b3IKICAgICAgICAgICAgICAgICAgICBpZiAoKGMgPT0gTkVXTElORSB8fCBjID09IEVPRiB8fCBjID09IFNQQUNFKSkgewogICAgICAgICAgICAgICAgICAgICAgICBPcGVyYXRlKGMsIHRoaXMgLT4gc3RhY2spOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvL0lmIG5lZ2F0aXZlIG51bWJlciwgYWRkcyB0byBzdHJpbmcgcmVwcmVzZW50YXRpdmUKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyY2F0KG51bSwgIi0iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvL09ubHkgZ29lcyBoZXJlIGlmIG51bWJlciAtIGMgIT0gc3BhY2UgbmVlZGVkIGluIGNhc2UgZXF1YXRpb24gbW92ZWQgdG8gc3BhY2UgCiAgICAgICAgaWYgKGMgIT0gU1BBQ0UgJiYgKCEoYyA9PSBORVdMSU5FIHx8IGMgPT0gRU9GKSkpIHsKICAgICAgICAgICAgLy9Xcml0ZXMgbnVtYmVyCiAgICAgICAgICAgIHdoaWxlICghKGMgPT0gTkVXTElORSB8fCBjID09IFNQQUNFIHx8IGMgPT0gRU9GKSkgewogICAgICAgICAgICAgICAgLy9HdWFyYW50ZWVzIHRoYXQgY2hhcmFjdGVyIGlzIGVpdGhlciBkb3Qgb3IgbnVtZXJpY2FsCiAgICAgICAgICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IDExOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWVzW2ldID09IGMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaXNGbG9hdCA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAxMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvL09ubHkgY29udGludWVzIGlmIHZhbGlkIG51bWJlcgogICAgICAgICAgICAgICAgaWYgKGlzRmxvYXQpIHsKICAgICAgICAgICAgICAgICAgICAvL0NvbnZlcnRzIGN1cnJlbnQgaW50IGNoYXIgdmFsdWUgdG8gc3RyaW5nIHRvIGFkZCB0byBudW0KICAgICAgICAgICAgICAgICAgICBpZiAoYyA9PSA0NikgewogICAgICAgICAgICAgICAgICAgICAgICAvL0NvbmNhdGVuYXRlcyB0byBtYWtlIG51bWJlciAtIGlmIGRvdAogICAgICAgICAgICAgICAgICAgICAgICBzdHJjYXQobnVtLCAiLiIpOwoKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwcmludGYobnVtMSwgIiVkIiwgYyAtIFpFUk8pOwogICAgICAgICAgICAgICAgICAgICAgICAvL0NvbmNhdGVuYXRlcyB0byBtYWtlIG51bWJlciwgY29udmVydHMgdG8gbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmNhdChudW0sIG51bTEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vRW5kcyBwcm9ncmFtIGlmIGludmFsaWQgaW5wdXQKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHByaW50ZigiQmFkIGV4cHJlc3Npb25cbiIpOwogICAgICAgICAgICAgICAgICAgIFN0YWNrX2Rlc3Ryb3kodGhpcy0+c3RhY2spOwogICAgICAgICAgICAgICAgICAgIGV4aXQoMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvL0NvbnRpbnVlcyB0cmF2ZXJzaW5nIG51bWJlcgogICAgICAgICAgICAgICAgaXNGbG9hdCA9IDA7CiAgICAgICAgICAgICAgICBjID0gZmdldGMoc3RkaW4pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL09uY2UgbnVtYmVyIGJ1aWx0LCBjb252ZXJ0cyB0byBmbG9hdAogICAgICAgICAgICBmID0gc3RydG9mKG51bSwgTlVMTCk7CiAgICAgICAgICAgIC8vUHVzaGVzIG9udG8gc3RhY2sKICAgICAgICAgICAgU3RhY2tfcHVzaCh0aGlzLT5zdGFjaywgZik7CiAgICAgICAgICAgIC8vUmVzZXRzIGFycmF5IHRvIGFsbG93IGZvciBuZXcgbnVtYmVyIHRvIGJlIHdyaXR0ZW4KICAgICAgICAgICAgbWVtc2V0KCZudW1bMF0sIDAsIHNpemVvZihudW0pKTsKICAgICAgICB9CgogICAgfQoKICAgIC8vSWYgc3RhY2sgc2l6ZSBpcyBsYXJnZXIgdGhhbiAxIG9yIGVtcHR5LCByZXR1cm5zIGJhZCBleHByZXNzaW9uLiBJbnZhbGlkIHN5bWJvbHMgYWxyZWFkeSBjb3ZlcmVkLgogICAgaWYgKFN0YWNrX3NpemUodGhpcy0+c3RhY2spICE9IDEpIHsKICAgICAgICBwcmludGYoIkJhZCBleHByZXNzaW9uXG4iKTsKICAgICAgICBTdGFja19kZXN0cm95KHRoaXMtPnN0YWNrKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIC8vUG9wIGZpbmFsIHZhbHVlIG9mZiBzdGFjayBhbmQgcmV0dXJuCiAgICAgICAgU3RhY2tfcG9wKHRoaXMtPnN0YWNrLCByZXMpOwogICAgICAgIHByaW50ZigiJS4yZiBcbiIsIHJlc3VsdCk7CiAgICAgICAgU3RhY2tfZGVzdHJveSh0aGlzLT5zdGFjayk7CiAgICB9Cn0KCi8qCiAqIFBlcmZvcm1zIG1hdGhlbWF0aWNhbCBjYWxjdWxhdGlvbiBnaXZlbiBhbiBvcGVyYW5kCiAqLwp2b2lkIE9wZXJhdGUoaW50IG9wZXJhbmQsIFN0YWNrKiBzdGFjaykgewogICAgLy9SZXByZXNlbnRzIGZpbmFsIHZhbHVlCiAgICBmbG9hdCB2YWx1ZSA9IDA7CiAgICAvL1JlcHJlc2VudHMgdHdvIHZhbHVlcyB0byBwZXJmb3JtIGNhbGN1bGF0aW9uCiAgICBmbG9hdCB2YWx1ZTEgPSAwOwogICAgZmxvYXQgdmFsdWUyID0gMDsKICAgIGZsb2F0KiB2YWwxID0gJnZhbHVlMTsKICAgIGZsb2F0KiB2YWwyID0gJnZhbHVlMjsKCiAgICAvL0RvZXNuJ3QgYWxsb3cgZm9yIGlucHV0IG9mIHNwYWNlcyBhbmQgb3BlcmFuZHMKICAgIGlmIChTdGFja19pc0VtcHR5KHN0YWNrKSkgewogICAgICAgIHByaW50ZigiQmFkIGV4cHJlc3Npb25cbiIpOwogICAgICAgIFN0YWNrX2Rlc3Ryb3koc3RhY2spOwogICAgICAgIGV4aXQoMSk7CiAgICB9CgogICAgLy9Qb3BzIHN0YWNrIHZhbHVlcyBpbnRvIHZhbHVlcwogICAgaWYgKCEoU3RhY2tfcG9wKHN0YWNrLCB2YWwxKSAmJiBTdGFja19wb3Aoc3RhY2ssIHZhbDIpKSkgewogICAgICAgIHByaW50ZigiQmFkIGV4cHJlc3Npb25cbiIpOwogICAgICAgIFN0YWNrX2Rlc3Ryb3koc3RhY2spOwogICAgICAgIGV4aXQoMSk7CiAgICB9CgogICAgLy9QZWZvcm1zIG9wZXJhdGlvbgogICAgc3dpdGNoKG9wZXJhbmQpIHsKICAgICAgICBjYXNlIChNVUxUSVBMSUNBVElPTikgOgogICAgICAgICAgICB2YWx1ZSA9IHZhbHVlMSAqIHZhbHVlMjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAoQURESVRJT04pIDoKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZTEgKyB2YWx1ZTI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vc3VidHJhY3Rpb24gLSBhcyBzdWJ0cmFjdGlvbiBvbmx5IGFwcGxpZXMgaWYgdGhpcyBpcyBjdXJyZW50IGMgdmFsdWUKICAgICAgICBjYXNlIChORVdMSU5FKSA6CiAgICAgICAgY2FzZSAoU1BBQ0UpIDoKICAgICAgICBjYXNlIChFT0YpIDoKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZTIgLSB2YWx1ZTE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vZGl2aXNpb24KICAgICAgICBjYXNlIChESVZJU0lPTikgOgogICAgICAgICAgICAvL1N0b3BzIGRpdmlzaW9uIGJ5IDAKICAgICAgICAgICAgaWYgKHZhbHVlMSA9PSAwLjAwKSB7CiAgICAgICAgICAgICAgICBwcmludGYoIkJhZCBleHByZXNzaW9uXG4iKTsKICAgICAgICAgICAgICAgIFN0YWNrX2Rlc3Ryb3koc3RhY2spOwogICAgICAgICAgICAgICAgZXhpdCgxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUyIC8gdmFsdWUxOwogICAgICAgICAgICB9ICAgICAgICAKICAgIH0KICAgIC8vUHVzaGVzIG9wZXJhdG9yIHRvIHN0YWNrCiAgICBTdGFja19wdXNoKHN0YWNrLCB2YWx1ZSk7Cgp9",
    description = "Base64 format of a file")
    private String base64Value;
    @Schema(example = "text/html", description = "MIME type of given file.")
    private String mime;


    public FileData(String filename, boolean isDir, String base64value, String mime) {
        super(filename, isDir);
        this.base64Value = (base64value == null) ? "" : base64value;
        this.mime = mime;
    }

    public FileData(@JsonProperty("filename")String filename, @JsonProperty("base64value") String base64value) {
        super(filename);
        this.base64Value = base64value;
        try {
            Path path = new File(filename).toPath();
            this.mime = Files.probeContentType(path);
        } catch (Exception e) {
            this.mime = null;
        }
    }

    public FileData(String base64value) {
        this("", true, base64value, "application/zip"); // assume it's a zip file
    }

    public String getBase64Value() {
        return (base64Value == null) ? "" : base64Value;
    }

    public void setBase64Value(String base64Value) {
        this.base64Value = (base64Value == null) ? "" : base64Value;
    }

    public String getMime() {
        return mime;
    }

    public void setMime(String mime) {
        this.mime = mime;
    }
}
